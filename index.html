<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gaze Overlay</title>

<script src="https://cdn.jsdelivr.net/npm/webgazer@2.1.0/dist/webgazer.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #000000; /* 黒クロマキー */
}

/* WebGazer内部（透明表示） */
video, canvas {
  position: fixed !important;
  top: 0;
  left: 0;
  opacity: 0.5 !important;
  z-index: 1000;
}

#gazeDot {
  position: fixed;
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: rgba(0, 255, 0, 0.35);
  border: 2px solid rgba(0,255,0,0.9);
  pointer-events: none;
  transform: translate(-50%, -50%);
}

#status {
  position: fixed;
  top: 10px;
  left: 10px;
  color: white;
  font-family: sans-serif;
  font-size: 14px;
  opacity: 0.7;
}
</style>
</head>

<body>
<div id="gazeDot"></div>
<div id="status">Initializing Eye Tracker...</div>

<script>
const dot = document.getElementById("gazeDot");
const statusText = document.getElementById("status");

/* スムージング用変数 */
let smoothX = window.innerWidth / 2;
let smoothY = window.innerHeight / 2;
const smoothFactor = 0.2;

/* 安定化設定 */
webgazer.setRegression("ridge");
webgazer.saveDataAcrossSessions(false);
localStorage.clear();

/* 視線取得 */
webgazer
  .setGazeListener((data) => {
    if (!data) return;

    smoothX += (data.x - smoothX) * smoothFactor;
    smoothY += (data.y - smoothY) * smoothFactor;

    dot.style.left = smoothX + "px";
    dot.style.top  = smoothY + "px";
  })
  .begin();

/* UI非表示 */
webgazer.showVideo(false);
webgazer.showPredictionPoints(false);
webgazer.showFaceOverlay(false);

/* 校正ガイド */
statusText.textContent = "中央→四隅を見る＆クリックして校正";

let clickCount = 0;
window.addEventListener('click', () => {
  clickCount++;

  dot.style.background = "rgba(255,255,0,0.8)";
  setTimeout(() => {
    dot.style.background = "rgba(0,255,0,0.35)";
  }, 150);

  if (clickCount >= 8) {
    statusText.style.display = "none";
  }
});
</script>
</body>
</html>
