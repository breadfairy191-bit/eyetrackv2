<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gaze Overlay</title>

<!-- WebGazer 安定版 -->
<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000000; /* 黒クロマキー */
  }

  video, canvas {
  display: none !important;
}


  #gazeDot {
    position: fixed;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(0, 255, 0, 0.35); /* 半透明グリーン */
    border: 2px solid rgba(0,255,0,0.8);
    pointer-events: none;
    transform: translate(-50%, -50%);
    transition: transform 0.05s linear;
  }

  #status {
    position: fixed;
    top: 10px;
    left: 10px;
    color: white;
    font-family: sans-serif;
    font-size: 14px;
    opacity: 0.7;
  }
</style>
</head>

<body>
<div id="gazeDot"></div>
<div id="status">Initializing Eye Tracker...</div>

<script>
const dot = document.getElementById("gazeDot");
const statusText = document.getElementById("status");

window.onload = async () => {
  statusText.textContent = "カメラを確認中...";

  await webgazer
    .setRegression('ridge')
    .setGazeListener((data) => {
      if (!data) return;
      dot.style.left = data.x + "px";
      dot.style.top = data.y + "px";
    })
    .begin();

  // 1. ビデオなどが完全に準備できるまで待つ
  statusText.textContent = "画面の四隅と中央をクリックして校正してください";

  // 2. 学習用のクリックイベントを追加
  window.addEventListener('click', (e) => {
    // クリックした瞬間にドットの色を変えるなどのフィードバックがあると良い
    dot.style.background = "rgba(255, 255, 0, 0.8)"; // クリック時だけ黄色に
    setTimeout(() => {
      dot.style.background = "rgba(0, 255, 0, 0.35)";
    }, 200);
    
    // 5回以上クリックされたらステータスを消すなどの演出
    checkCalibration();
  });

  // UIを隠す設定は維持
  webgazer.showVideo(false);
  webgazer.showPredictionPoints(false);
};

let clickCount = 0;
function checkCalibration() {
  clickCount++;
  if (clickCount >= 5) {
    statusText.style.display = "none"; // 5回クリックで準備完了とみなす
  }
}
</script>
</body>
</html>
